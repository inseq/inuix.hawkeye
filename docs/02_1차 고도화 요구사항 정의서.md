# 호크아이 고도화 요구사항 정의서

## 1. 전역 on/off 옵션
- 호크아이 도구의 전역 활성화/비활성화 옵션 제공
- 설정 객체의 `enabled` 속성으로 전역 on/off 상태 제어
- 전역 옵션이 `false`인 경우 호크아이 도구 초기화 및 UI 렌더링 생략

## 2. URL 패턴 감지 및 브랜치별 on/off 처리
- URL 패턴 분석을 통한 PMS 환경 감지
- PMS 환경인 경우, URL에서 브랜치명 추출
  - URL 패턴: `PMS도메인/그룹명/프로젝트명/files/브랜치명/path 및 파일명`
  - URL 인코딩된 브랜치명 고려 (예: `feature%2Fcomponents-ui`)
- 설정 객체에 브랜치별 on/off 상태 저장 구조 마련
- 추출한 브랜치명 기반으로 해당 브랜치의 on/off 상태 확인 및 적용
- 브랜치명이 설정 객체에 없는 경우 기본값 `true` 사용

## 3. 도메인별 노출 여부 설정
- 도메인별 호크아이 도구 노출 여부 설정 기능 추가
- 설정 객체의 `domains` 속성으로 도메인별 on/off 상태 관리
- 현재 도메인 확인 후 `domains` 설정에서 해당 도메인의 on/off 상태 확인 및 적용
- 도메인이 설정 객체에 없는 경우 기본값 `true` 사용

## 4. 예외 상황 처리
- PMS 도메인 변경, 브랜치 패턴 변경, 브랜치 옵션 미설정, PMS 환경이 아닌 경우 등의 예외 상황 처리
- 설정 객체 유효성 검사 및 기본값 처리 추가

## 5. 안정성 개선
- 에러 처리 및 로깅 강화
  - try-catch 문을 사용하여 주요 로직의 에러 처리
  - 에러 발생 시 상세 정보 로깅 및 사용자에게 알림
  - 에러 발생 후에도 호크아이 도구의 정상 동작 유지
- 비동기 작업 처리
  - Promise 또는 async/await 문법을 사용하여 비동기 작업 처리
  - 비동기 작업 완료 후 적절한 후속 처리 수행
  - 비동기 작업 중 발생한 에러 처리 및 로깅
- 성능 최적화
  - 불필요한 DOM 조작 최소화
  - 이벤트 리스너 등록 시 성능 고려 (예: 이벤트 위임 사용)
  - 반복적인 작업에 대한 최적화 (예: requestAnimationFrame 사용)

## 6. 이미지 상태 저장 및 초기화
- 기존 코드의 이미지 상태 저장 및 초기화 로직 유지
  - IndexedDB를 사용한 상태 저장 및 복원
  - 상태 저장 실패 시 LocalStorage 폴백 사용
  - 새 이미지 업로드 시 상태 초기화
  - 상태 복원 시 이미지 위치, 크기, 투명도, 반전, 잠금, 가시성 등 복원
- 전역 옵션, 브랜치별 옵션, 도메인별 옵션 추가에 따른 초기화 로직 확장
  - 옵션에 따라 초기화 및 UI 렌더링 여부 결정
  - 옵션 변경 시 상태 초기화 및 UI 업데이트 처리

# 호크아이 기능정의서

## 1. 전역 on/off 옵션
- `enabled` 속성으로 전역 on/off 상태 설정
- 전역 옵션이 `false`인 경우 호크아이 도구 초기화 및 UI 렌더링 생략

## 2. PMS 환경 감지
- `window.location.hostname`으로 현재 페이지 도메인 확인
- 설정 객체의 `pms.domain` 값과 비교하여 PMS 환경 판단

## 3. 브랜치 감지 및 on/off 처리
- `window.location.pathname`으로 현재 페이지 URL 경로 확인
- 설정된 URL 패턴 기반으로 브랜치명 추출
  - 패턴: `/^\/\w+\/\w+\/files\/([\w-]+)/`
  - 추출된 브랜치명 URL 디코딩하여 사용
- 추출된 브랜치명을 설정 객체의 `pms.branches`에서 찾아 on/off 상태 확인
  - 브랜치명이 설정 객체에 없는 경우 기본값 `true` 사용

## 4. 도메인별 노출 여부 설정
- 설정 객체의 `domains` 속성으로 도메인별 on/off 상태 관리
- `window.location.hostname`으로 현재 도메인 확인 후 `domains` 설정에서 해당 도메인의 on/off 상태 확인
  - 도메인이 설정 객체에 없는 경우 기본값 `true` 사용

## 5. 초기화 로직
- 전역 on/off 옵션, PMS 환경 감지, 브랜치별 on/off 처리, 도메인별 노출 여부를 종합하여 호크아이 도구 초기화 여부 결정
- 초기화 조건 만족 시 호크아이 도구 UI 렌더링 및 기능 활성화
- 옵션 변경 시 상태 초기화 및 UI 업데이트 처리

## 6. 이미지 상태 저장 및 복원
- IndexedDB를 사용한 상태 저장 및 복원 로직 유지
  - 이미지 업로드 시 상태 저장
  - 페이지 로드 시 상태 복원
- 상태 저장 시 이미지 데이터, 위치, 크기, 투명도, 반전, 잠금, 가시성 등 저장
- 상태 복원 시 저장된 상태를 기반으로 이미지 및 UI 복원
- 상태 저장 실패 시 LocalStorage 폴백 사용

## 7. 에러 처리 및 로깅
- 주요 로직을 try-catch 문으로 감싸 에러 처리
- 에러 발생 시 console.error를 사용하여 상세 정보 로깅
- 에러 발생 후에도 호크아이 도구의 정상 동작 유지를 위한 예외 처리

## 8. 비동기 작업 처리
- IndexedDB 초기화, 상태 저장 및 복원 등의 비동기 작업을 Promise 또는 async/await을 사용하여 처리
- 비동기 작업 완료 후 적절한 후속 처리 수행
- 비동기 작업 중 발생한 에러 처리 및 로깅

## 9. 성능 최적화
- 불필요한 DOM 조작 최소화
  - 초기 렌더링 시에만 UI 템플릿 생성 및 이벤트 리스너 등록
  - 상태 변경 시 필요한 부분만 업데이트
- 이벤트 리스너 등록 시 성능 고려
  - 가능한 경우 이벤트 위임 사용
  - 빈번한 이벤트의 경우 throttle 또는 debounce 적용
- 반복적인 작업에 대한 최적화
  - Moveable 인스턴스 업데이트 시 requestAnimationFrame 사용
  - 상태 저장 시 일정 시간 딜레이 후 저장하여 불필요한 저장 호출 최소화

## 10. 설정 객체 구조
```javascript
const config = {
  enabled: true,
  pms: {
    domain: 'pms.inseq.co.kr',
    enabled: true,
    branches: {
      'develop': true,
      'master': false,
      // ...
    },
  },
  domains: {
    'example.com': false,
    // ...
  },
  // ...
};
```

- 기존 코드의 이미지 상태 저장 및 초기화 로직을 유지하면서 전역 옵션, 브랜치별 옵션, 도메인별 옵션을 추가하는 것이 중요
- 이를 위해 초기화 로직을 확장하여 옵션에 따른 초기화 및 UI 렌더링 여부를 결정하고, 옵션 변경 시 상태 초기화 및 UI 업데이트를 처리해야 함
- 또한, 에러 처리 및 로깅, 비동기 작업 처리, 성능 최적화 등을 통해 호크아이 도구의 안정성과 사용자 경험을 개선할 수 있을 것
- 구현 과정에서 세부적인 사항들을 꼼꼼히 검토하고 테스트하여 안정적인 동작을 보장 필요